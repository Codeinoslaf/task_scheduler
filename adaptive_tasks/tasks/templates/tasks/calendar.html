{% extends 'tasks/base.html' %}
{% load static %}

{% block title %}–ö–∞–ª–µ–Ω–¥–∞—Ä—å{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'tasks/css/calendar.css' %}">
{% endblock %}

{% block content %}
<div class="calendar-layout">
    <div class="calendar-shell" id="calendar-shell">
        <header class="calendar-header">
            <div class="calendar-title-wrap">
                <h1 id="current-month-year">–Ø–Ω–≤–∞—Ä—å 2026</h1>
                <p class="calendar-subtitle">–ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ —Å–≤–æ–∏ –∑–∞–¥–∞—á–∏</p>
            </div>
            <div class="calendar-nav">
                <button onclick="previousMonth()">‚Üê –ù–∞–∑–∞–¥</button>
                <button onclick="nextMonth()">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
                <button onclick="goToday()">–°–µ–≥–æ–¥–Ω—è</button>
            </div>
        </header>

        <div class="calendar-grid">
            <div class="calendar-weekdays">
                <div class="weekday">–ü–Ω</div>
                <div class="weekday">–í—Ç</div>
                <div class="weekday">–°—Ä</div>
                <div class="weekday">–ß—Ç</div>
                <div class="weekday">–ü—Ç</div>
                <div class="weekday">–°–±</div>
                <div class="weekday">–í—Å</div>
            </div>
            <div class="calendar-days" id="calendar-days">
                <!-- –î–Ω–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è JavaScript -->
            </div>
        </div>
    </div>

    <aside id="side-panel" class="side-panel">
        <div class="side-panel__head">
            <h2 id="panel-title">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
            <button type="button" class="side-panel__close" onclick="closePanel()">‚úï</button>
        </div>

        <form class="side-panel__form" id="task-form" method="post" action="{% url 'calendar' %}" onsubmit="return handleFormSubmit(event)">
            {% csrf_token %}
            <input type="hidden" name="task_id" id="task-id">
            <input type="hidden" name="planned_deadline" id="hidden-deadline">

            <div class="form-group">
                <label for="task-title">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                <input type="text" id="task-title" name="title" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
            </div>

            <div class="form-group">
                <label for="task-description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="task-description" name="description" placeholder="–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
            </div>

            <div class="form-group">
                <label for="task-deadline">–í—Ä–µ–º—è</label>
                <input type="time" id="task-deadline" required>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn">
                    <span>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                </button>
                <button type="button" class="btn btn--secondary" onclick="closePanel()">
                    <span>–û—Ç–º–µ–Ω–∞</span>
                </button>
            </div>
        </form>

        <div id="panel-tasks-section" style="display: none;">
            <h3 style="margin: 24px 0 16px; font-size: 18px; color: #cbd5e1;">–ó–∞–¥–∞—á–∏ –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</h3>
            <div class="panel-tasks-list" id="panel-tasks-list">
                <!-- –ó–∞–¥–∞—á–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </aside>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentDate = new Date();
    let selectedDate = null;

    // –î–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á
    const tasksData = {{ tasks_json|safe }};

    const monthNames = [
        '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
        '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
    ];

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        document.getElementById('current-month-year').textContent =
            `${monthNames[month]} ${year}`;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const prevLastDay = new Date(year, month, 0);

        const firstDayWeek = firstDay.getDay() || 7;
        const daysInMonth = lastDay.getDate();
        const daysInPrevMonth = prevLastDay.getDate();

        const calendarDays = document.getElementById('calendar-days');
        calendarDays.innerHTML = '';

        // –î–Ω–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        for (let i = firstDayWeek - 1; i > 0; i--) {
            const day = daysInPrevMonth - i + 1;
            calendarDays.innerHTML += createDayElement(day, true);
        }

        // –î–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const isToday = date.toDateString() === today.toDateString();
            const tasksCount = getTasksForDate(date).length;

            calendarDays.innerHTML += createDayElement(
                day,
                false,
                isToday,
                tasksCount,
                `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`
            );
        }

        // –î–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        const totalCells = calendarDays.children.length;
        const remainingCells = (7 - (totalCells % 7)) % 7;
        for (let day = 1; day <= remainingCells; day++) {
            calendarDays.innerHTML += createDayElement(day, true);
        }
    }

    function createDayElement(day, isOtherMonth, isToday = false, tasksCount = 0, dateStr = '') {
        let classes = 'calendar-day';
        if (isOtherMonth) classes += ' calendar-day--other-month';
        if (isToday) classes += ' calendar-day--today';
        if (tasksCount > 0) classes += ' calendar-day--has-tasks';

        const taskCountHtml = tasksCount > 0 ? `<div class="task-count">${tasksCount} –∑–∞–¥–∞—á</div>` : '';
        const onclick = isOtherMonth ? '' : `onclick="openPanel('${dateStr}')"`;

        return `
            <div class="${classes}" ${onclick}>
                <div class="day-number">${day}</div>
                ${taskCountHtml}
            </div>
        `;
    }

    function getTasksForDate(date) {
        const dateStr = date.toISOString().split('T')[0];
        return tasksData.filter(task => {
            const taskDate = new Date(task.planned_deadline).toISOString().split('T')[0];
            return taskDate === dateStr;
        });
    }

    function openPanel(dateStr) {
        selectedDate = dateStr;
        const panel = document.getElementById('side-panel');
        const shell = document.getElementById('calendar-shell');

        panel.classList.add('side-panel--active');
        shell.classList.add('calendar-shell--shifted');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–¥–∞—á–∏ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É
        const tasks = tasksData.filter(task => {
            const taskDate = new Date(task.planned_deadline).toISOString().split('T')[0];
            return taskDate === dateStr;
        });

        const tasksSection = document.getElementById('panel-tasks-section');
        const tasksList = document.getElementById('panel-tasks-list');

        if (tasks.length > 0) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–¥–∞—á–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö —Å–ø–∏—Å–æ–∫
            tasksSection.style.display = 'block';
            document.getElementById('task-form').style.display = 'none';
            document.getElementById('panel-title').textContent = `–ó–∞–¥–∞—á–∏ –Ω–∞ ${formatDate(dateStr)}`;

            tasksList.innerHTML = tasks.map(task => `
                <div class="panel-task-item">
                    <div class="panel-task-title">${task.title}</div>
                    <div class="panel-task-time">
                        üïê ${new Date(task.planned_deadline).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}
                    </div>
                    ${task.description ? `<p style="font-size: 13px; color: #94a3b8; margin: 8px 0 0;">${task.description}</p>` : ''}
                    <div class="panel-task-actions">
                        <button class="task-action-btn task-action-btn--complete" onclick="editTask(${task.id}, event)" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa; border-color: rgba(59, 130, 246, 0.3);">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                        ${task.status !== 'completed' ?
                `<button class="task-action-btn task-action-btn--complete" onclick="completeTask(${task.id})">‚úì –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>` :
                `<span style="color: #86efac; font-size: 13px; padding: 8px;">‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>`
            }
                        <button class="task-action-btn task-action-btn--delete" onclick="deleteTask(${task.id})">üóë –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
            tasksList.innerHTML += `
                <button class="btn" style="width: 100%; margin-top: 12px;" onclick="showNewTaskForm('${dateStr}')">
                    <span>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É</span>
                </button>
            `;
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç –∑–∞–¥–∞—á - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è
            showNewTaskForm(dateStr);
        }
    }

    function showNewTaskForm(dateStr) {
        document.getElementById('task-form').style.display = 'flex';
        document.getElementById('panel-tasks-section').style.display = 'none';

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è, –¥–∞—Ç–∞ —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞
        const currentTime = new Date().toTimeString().slice(0, 5); // HH:MM
        document.getElementById('task-deadline').value = currentTime;
        document.getElementById('panel-title').textContent = `–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –Ω–∞ ${formatDate(dateStr)}`;
        document.getElementById('task-form').reset();
        document.getElementById('task-id').value = '';
        document.getElementById('task-deadline').value = currentTime;
        document.getElementById('task-deadline').dataset.date = dateStr;
    }

    function editTask(taskId, event) {
        event.stopPropagation();
        const task = tasksData.find(t => t.id === taskId);
        if (!task) return;

        document.getElementById('task-form').style.display = 'flex';
        document.getElementById('panel-tasks-section').style.display = 'none';

        const taskDate = new Date(task.planned_deadline);
        const dateStr = taskDate.toISOString().split('T')[0];
        const timeStr = taskDate.toTimeString().slice(0, 5);

        document.getElementById('panel-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏';
        document.getElementById('task-id').value = task.id;
        document.getElementById('task-title').value = task.title;
        document.getElementById('task-description').value = task.description || '';
        document.getElementById('task-deadline').value = timeStr;
        document.getElementById('task-deadline').dataset.date = dateStr;
    }

    function handleFormSubmit(event) {
        const deadlineInput = document.getElementById('task-deadline');
        const dateStr = deadlineInput.dataset.date || selectedDate;
        const timeStr = deadlineInput.value;

        // –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
        const fullDatetime = `${dateStr}T${timeStr}`;
        document.getElementById('hidden-deadline').value = fullDatetime;

        return true;
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        const day = date.getDate();
        const month = monthNames[date.getMonth()];
        return `${day} ${month}`;
    }

    function closePanel() {
        const panel = document.getElementById('side-panel');
        const shell = document.getElementById('calendar-shell');

        panel.classList.remove('side-panel--active');
        shell.classList.remove('calendar-shell--shifted');
    }

    function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    }

    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    }

    function goToday() {
        currentDate = new Date();
        renderCalendar();
    }

    function completeTask(taskId) {
        window.location.href = `/task/${taskId}/complete/`;
    }

    function deleteTask(taskId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) {
            fetch(`/task/${taskId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            }).then(() => {
                location.reload();
            });
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    renderCalendar();
</script>
{% endblock %}